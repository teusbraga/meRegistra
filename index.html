<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>meRegistra! [Alpha]</title>
	<link rel="stylesheet" href="css/meRegistra.css">
</head>
<body>
<h1>meRegistra!</h1>

<div id="novoCadastro">
    <div id="formularioDiv">
        <form id="registro">
            <label for="num-registro">Número de Registro</label>
            <input type="text" id="num-registro" name="num-registro" maxlength="18" oninput="apenasNumeros(event)" required>
            <br><br>
            <label for="idade">Idade</label>
            <input type="number" id="idade" name="idade" min="1" required>
            <br><br>
            <label for="genero">Gênero</label>
            <select id="genero" name="genero" required>
                <option value="0" selected>Feminino</option>
                <option value="1">Masculino</option>
            </select>
            <br><br>
            <label for="escolaridade">Escolaridade</label>
            <select id="escolaridade" name="escolaridade" required>
                <option value="1" selected>Fundamental</option>
                <option value="2">Médio</option>
                <option value="3">Superior</option>
            </select>
            <br><br>
            <label for="polifarmacia">Polifarmácia</label>
            <select id="polifarmacia" name="polifarmacia" required>
                <option value="1">Sim</option>
                <option value="0" selected>Não</option>
            </select>
            <br><br>
            <label for="comorbidades">Comorbidades</label>
            <input type="number" id="comorbidades" name="comorbidades" min="0" value="0" required>
        </form>
    </div>

    <div id="perguntasDiv">
	<form>
        <table>
        <thead>
        <tr>
            <!-- Cabeçalho: Mesclando as colunas e linhas -->
            <th rowspan="2">Perguntas</th>
            <th colspan="2">Pacientes</th>
            <th colspan="2">Acompanhante</th>
		</tr>
		<tr>
            <th>SIM</th>
            <th>NÃO</th>
            <th>SIM</th>
            <th>NÃO</th>
        </tr>
            </thead>
            <tbody>
                <script>
                    const perguntas = [
                        "Dores no corpo?",
                        "Quedas?",
                        "Não sentir sede?",
                        "Esquecimento que prejudica as atividades do dia a dia?",
                        "Não ter vontade de sair de casa?",
                        "Pele seca?",
                        "Ter hipertensão arterial?",
                        "Sentir tontura?",
                        "Perde urina com facilidade?",
                        "Ter muitas doenças e tomar muitos remédios?",
                        "Ter dificuldade para andar?",
                        "Dormir pouco?",
                        "Não escutar bem?",
                        "Ter dificuldade para enxergar?",
                        "Não sentir gosto dos alimentos?",
                        "Redução da estatura?",
                    ];

                    perguntas.forEach((pergunta, index) => {
                        document.write(`<tr>
                            <td>${pergunta}</td>
                            <td><input type="radio" name="paciente_q${index + 1}" value="1" required></td>
                            <td><input type="radio" name="paciente_q${index + 1}" value="0"></td>
                            <td><input type="radio" name="acomp_q${index + 1}" value="1" required></td>
                            <td><input type="radio" name="acomp_q${index + 1}" value="0"></td>
                        </tr>`);
                    });
                </script>
            </tbody>
        </table>
		<button type="reset">Limpar Seleção</button>
		</form>
    </div>
    <br>
    <button type="button" id="save-data">Salvar Dados</button>
    
    <button type="button" id="export-data">Exportar JSON</button>
    <label for="import-data" class="button">Importar JSON</label>
    <input type="file" id="import-data" accept="application/json" style="display:none;">

</div>
<br><br><br>
<div id="saved-data"></div>
<br><br><br>
<a id="reset-data">Resetar Dados</a>

</body>
<script> class Paciente {
    constructor() {
        const numRegistro = document.getElementById("num-registro").value;
        const idade = parseInt(document.getElementById("idade").value, 10);
		const comorbidades = parseInt(document.getElementById("comorbidades").value, 10);
		const polifarmacia = document.getElementById("polifarmacia").value;
        if (!numRegistro) {
            throw new Error("Número de Registro é obrigatório.");
        }
        if (isNaN(idade) || idade < 1) {
            throw new Error("Idade deve ser um número positivo maior que zero.");
        }
		if (isNaN(comorbidades) || comorbidades < 0) {
            throw new Error("Comorbidades deve ser um número positivo.");
        }

        this.numRegistro = numRegistro;
        this.idade = idade;
        this.genero = document.getElementById("genero").value || null;
        this.escolaridade = document.getElementById("escolaridade").value || null;
        this.polifarmacia = [polifarmacia];
        this.comorbidades = [comorbidades];
        this.rp = [];
        this.ra = [];
        this.data_hora = new Date().toISOString(); // Timestamp automático
    }
	coletarRespostas() {
        for (let i = 1; i <= 16; i++) {
            const respostaPaciente = document.querySelector(`input[name=paciente_q${i}]:checked`);
            this.rp.push(respostaPaciente ? respostaPaciente.value : null);

            const respostaAcomp = document.querySelector(`input[name=acomp_q${i}]:checked`);
            this.ra.push(respostaAcomp ? respostaAcomp.value : null);
        }
    }
    // Método para salvar ou atualizar o paciente no localStorage
    save() {
        const CPF = `paciente_${this.numRegistro}`;

        // Verificar se o CPF já existe
        const existingData = JSON.parse(localStorage.getItem(CPF)) || [];
        if (existingData.length > 0) {
            throw new Error(`Paciente com o número de registro ${this.numRegistro} já existe!`);
        }

        // Adiciona a nova versão do paciente ao histórico
        existingData.push(this);

        // Salva o histórico completo
        localStorage.setItem(CPF, JSON.stringify(existingData));
        console.log(`Paciente ${this.numRegistro} salvo com sucesso!`);
    }

    // Método para obter os dados mais recentes do paciente
    static read(numRegistro) {
        const CPF = `paciente_${numRegistro}`;
        const existingData = JSON.parse(localStorage.getItem(CPF));

        if (existingData && existingData.length > 0) {
            console.log(`Última versão do Paciente ${numRegistro} carregada.`);
            return existingData[existingData.length - 1]; // Retorna a última versão
        } else {
            console.warn(`Paciente ${numRegistro} não encontrado!`);
            return null;
        }
    }

    // Método para obter o histórico completo do paciente
    static history(numRegistro) {
        const CPF = `paciente_${numRegistro}`;
        const existingData = JSON.parse(localStorage.getItem(CPF));

        if (existingData && existingData.length > 0) {
            console.log(`Histórico completo do Paciente ${numRegistro} carregado.`);
            return existingData; // Retorna o histórico completo
        } else {
            console.warn(`Histórico do Paciente ${numRegistro} não encontrado!`);
            return [];
        }
    }

    // Método estático para remover o paciente do localStorage
    static remove(numRegistro) {
        const CPF = `paciente_${numRegistro}`;
        localStorage.removeItem(CPF);
        console.log(`Paciente ${numRegistro} e seu histórico foram removidos.`);
    }
}

// Botão para salvar dados
document.getElementById("save-data").addEventListener("click", () => {
    try {
        const paciente = new Paciente();
		paciente.coletarRespostas();
        paciente.save();
        alert("Dados salvos com sucesso!");
    } catch (error) {
        alert(error.message);
    }
});

// Botão para exportar JSON
document.getElementById("export-data").addEventListener("click", () => {
    const pacientes = [];
    for (let key in localStorage) {
        if (key.startsWith("paciente_")) {
            pacientes.push(...JSON.parse(localStorage.getItem(key)));
        }
    }
    const blob = new Blob([JSON.stringify(pacientes, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "pacientes.json";
    link.click();
    URL.revokeObjectURL(url);
});

// Botão para importar JSON
document.getElementById("import-data").addEventListener("change", async (event) => {
    const file = event.target.files[0];
    if (file) {
        const text = await file.text();
        const importedData = JSON.parse(text);
        importedData.forEach((paciente) => {
            const key = `paciente_${paciente.numRegistro}`;
            localStorage.setItem(key, JSON.stringify([paciente]));
        });
        alert("Dados importados com sucesso!");
    }
});

// Botão para resetar dados
document.getElementById("reset-data").addEventListener("click", () => {
    if (confirm("Tem certeza que deseja apagar todos os dados?")) {
        localStorage.clear();
        alert("Todos os dados foram apagados.");
    }
});
// Atualiza o conteúdo da div saved-data
function atualizarSavedData() {
    const savedDataDiv = document.getElementById("saved-data");
    savedDataDiv.innerHTML = ""; // Limpa a div antes de atualizar

    const pacientes = [];
    for (let key in localStorage) {
        if (key.startsWith("paciente_")) {
            pacientes.push(...JSON.parse(localStorage.getItem(key)));
        }
    }

    if (pacientes.length === 0) {
        savedDataDiv.innerHTML = "<p>Nenhum dado salvo.</p>";
        return;
    }

    // Cria uma tabela para exibir os dados
    const table = document.createElement("table");
    table.border = "1";
    const thead = document.createElement("thead");
    thead.innerHTML = `
        <tr>
            <th>Número de Registro</th>
            <th>Idade</th>
            <th>Gênero</th>
            <th>Escolaridade</th>
            <th>Polifarmácia</th>
            <th>Comorbidades</th>
            <th>Última Atualização</th>
        </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    pacientes.forEach((paciente) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${paciente.numRegistro}</td>
            <td>${paciente.idade}</td>
            <td>${paciente.genero === "0" ? "Feminino" : "Masculino"}</td>
            <td>${["Fundamental", "Médio", "Superior"][paciente.escolaridade - 1]}</td>
            <td>${paciente.polifarmacia === "1" ? "Sim" : "Não"}</td>
            <td>${paciente.comorbidades}</td>
            <td>${new Date(paciente.data_hora).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    savedDataDiv.appendChild(table);
}
document.getElementById("save-data").addEventListener("click", () => {
    try {
        const paciente = new Paciente();
        paciente.save();
        alert("Dados salvos com sucesso!");
        atualizarSavedData(); // Atualiza a div
    } catch (error) {
        alert(error.message);
    }
});
document.getElementById("import-data").addEventListener("change", async (event) => {
    const file = event.target.files[0];
    if (file) {
        const text = await file.text();
        const importedData = JSON.parse(text);
        importedData.forEach((paciente) => {
            const key = `paciente_${paciente.numRegistro}`;
            localStorage.setItem(key, JSON.stringify([paciente]));
        });
        alert("Dados importados com sucesso!");
        atualizarSavedData(); // Atualiza a div
    }
});
document.getElementById("reset-data").addEventListener("click", () => {
    if (confirm("Tem certeza que deseja apagar todos os dados?")) {
        localStorage.clear();
        alert("Todos os dados foram apagados.");
        atualizarSavedData(); // Atualiza a div
    }
});
document.addEventListener("DOMContentLoaded", () => {
    atualizarSavedData();
});
function atualizarSavedData() {
    const savedDataDiv = document.getElementById("saved-data");
    savedDataDiv.innerHTML = ""; // Limpa a div antes de atualizar

    const pacientes = [];
    for (let key in localStorage) {
        if (key.startsWith("paciente_")) {
            pacientes.push(...JSON.parse(localStorage.getItem(key)));
        }
    }

    if (pacientes.length === 0) {
        savedDataDiv.innerHTML = "<p>Nenhum dado salvo.</p>";
        return;
    }

    // Cria uma tabela para exibir os dados
    const table = document.createElement("table");
    table.border = "1";
    const thead = document.createElement("thead");
    thead.innerHTML = `
        <tr>
            <th>Número de Registro</th>
            <th>Idade</th>
            <th>Gênero</th>
            <th>Escolaridade</th>
            <th>Polifarmácia</th>
            <th>Comorbidades</th>
            <th>Última Atualização</th>
            <th>Ações</th>
        </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    pacientes.forEach((paciente) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${paciente.numRegistro}</td>
            <td>${paciente.idade}</td>
            <td>${paciente.genero === "0" ? "Feminino" : "Masculino"}</td>
            <td>${["Fundamental", "Médio", "Superior"][paciente.escolaridade - 1]}</td>
            <td>${paciente.polifarmacia[0] === "1" ? "Sim" : "Não"}</td>
            <td>${paciente.comorbidades[0]}</td>
            <td>${new Date(paciente.data_hora).toLocaleString()}</td>
        `;

        // Botão de excluir
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Apagar";
        deleteBtn.addEventListener("click", () => {
            if (confirm(`Tem certeza que deseja apagar o registro ${paciente.numRegistro}?`)) {
                localStorage.removeItem(`paciente_${paciente.numRegistro}`);
                alert(`Registro ${paciente.numRegistro} apagado com sucesso!`);
                atualizarSavedData(); // Atualiza a tabela após a exclusão
            }
        });

        const actionsTd = document.createElement("td");
        actionsTd.appendChild(deleteBtn);
        tr.appendChild(actionsTd);

        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    savedDataDiv.appendChild(table);
}
    function apenasNumeros(event) {
        const inpult = event.target;
        inpult.value = inpult.value.replace(/[^0-9]/g, '');
    }

</script>

</html>
